name: Validate Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'

jobs:
  validate:
    name: Validate Workflow Syntax
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        pip install PyYAML
    
    - name: Validate workflow syntax
      run: |
        echo "üîç Validating workflow files..."
        for file in .github/workflows/*.yml; do
          echo "Checking $file..."
          python -c "
        import yaml
        import sys
        try:
            with open('$file', 'r') as f:
                yaml.safe_load(f)
            print('‚úÖ $file is valid')
        except Exception as e:
            print(f'‚ùå $file has syntax errors: {e}')
            sys.exit(1)
        "
        done
        echo "‚úÖ All workflow files are valid!"
    
    - name: Check for potential secrets
      run: |
        echo "üîç Checking for potential secrets in workflows..."
        if grep -r -i "password\|secret\|key\|token" .github/workflows/ --exclude="*.md"; then
          echo "‚ö†Ô∏è  Warning: Potential secrets found in workflow files"
          echo "Please review the following files:"
          grep -r -i "password\|secret\|key\|token" .github/workflows/ --exclude="*.md" || true
          echo "This is just a warning - please ensure no actual secrets are committed"
        else
          echo "‚úÖ No potential secrets found in workflow files"
        fi
    
    - name: Validate required jobs exist
      run: |
        echo "üîç Checking for required CI jobs..."
        required_jobs=("lint" "test" "typecheck" "tox")
        
        for job in "${required_jobs[@]}"; do
          if grep -q "name:.*$job\|job:.*$job" .github/workflows/ci.yml; then
            echo "‚úÖ Found job: $job"
          else
            echo "‚ùå Missing required job: $job"
            exit 1
          fi
        done
        echo "‚úÖ All required CI jobs are present!" 